---
title: A Stage-Based Population Model for Loggerhead Sea Turtles, after @crouse1987
author: "Tamora James (APS)"
date: "16 February 2016"
output: html_document
bibliography: loggerhead.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(gridExtra)
source("loggerhead_fun.R")
```

This workbook follows the matrix population model methods and analyses outlined in @crouse1987.

First, import the turtle data [@crouse1987, Table 3] and add a column for stage length, then set up the projection matrix.

```{r dataimport}
turtleData <- read.csv("~/Projects/popmod/crouse/loggerhead.crouse1987.csv") %>%
    mutate(stage.length = max.age - min.age)
A <- with(turtleData, createProjectionMatrix(surv, fecund, stage.length))
print(A, digits=4)
```

@crouse1987 calculate the eigenvalues and eigenvectors using the power
method. Here I'll use just use eigen() to get the eigenvalues and vectors.

```{r eigen}
eig <- eigen(A, symmetric = FALSE)
lambda <- eig$values[1]
r <- Re(log(lambda))
```
This gives $\lambda_m = `r round(Re(lambda), digits=4)`$ and $r = `r round(Re(r), digits=4)`$
which are pretty close to the values $\lambda_m = 0.9450$ and
$r = -0.0565$ generated by @crouse1987.

The stable stage distribution is given by the right eigenvector (coerced here
to its real part).

```{r ssd}
w1 <- Re(eig$vectors[,1])
turtleData <- mutate(turtleData, stage.dist = Re(w1/sum(w1)))
```

```{r ssd-plot, echo=FALSE}
ggplot(turtleData, aes(x = stage, y = stage.dist))+
    geom_bar(stat="identity", fill="grey", width = 0.8)+
    xlab("Stage")+
    ylab("Proportion of individuals")+
    scale_x_discrete(limits=turtleData$class)+
    #scale_y_continuous(limits=c(0, 1))+
    theme_classic()+
    theme(axis.text.x = element_text(angle = 45, hjust=1, size=12),
          axis.line.x = element_line(lineend = 0.5))
```

Most individuals belong to the eggs/hatchlings and small juvenile stages.

The reproductive value is given by the left eigenvector, which we get by
calculating the eigenvectors of the transpose of the projection matrix.

```{r repro}
v1 <- eigen(t(A), symmetric = FALSE)$vectors[,1]
turtleData <- mutate(turtleData, repro.val = Re(v1/v1[1]))
```
```{r ssd-repro-table, echo=FALSE}
print(select(turtleData, class, stage.dist, repro.val), digits=3)
```

The mean reproductive value can be calculated from the reproductive value and stable stage distribution as `r with(turtleData, round(Re(repro.val %*% stage.dist), digits=4))`.

## Sensitivity analyses

First, determine the impact of reduction or increase in fecundity or stage-specific survival parameters, each taken separately, on the intrinsic rate of increase $r$.

```{r sensitivity, warning=FALSE}
perm <- rbind(c(1,0), cbind(F=0, S=1:7))
sens <- t(apply(perm, MARGIN = 1, function(x) {
    td <- turtleData %>% mutate(surv.dec = ifelse(stage==x["S"], surv*0.5, surv),
                                fecund.dec = ifelse(x["F"],0.5,1)*fecund,
                                surv.inc = ifelse(stage==x["S"], 1.0, surv),
                                fecund.inc = ifelse(x["F"],2,1)*fecund)

    A <- with(td, createProjectionMatrix(surv.dec, fecund.dec, stage.length))
    eig <- eigen(A, symmetric = FALSE)
    r.dec <- Re(log(eig$values[1]))

    A <- with(td, createProjectionMatrix(surv.inc, fecund.inc, stage.length))
    eig <- eigen(A, symmetric = FALSE)
    r.inc <- Re(log(eig$values[1]))

    return(c(grow.dec=r.dec, grow.inc=r.inc))
}))
sens <- data.frame(perm,sens)
```

```{r sens-plot, echo=FALSE}
lim=c(min(sens$grow.dec, sens$grow.inc),
      max(sens$grow.dec, sens$grow.inc))

p1 <- ggplot(sens, aes(x = S+1, y = grow.dec))+
    geom_bar(stat="identity", position = "identity",
             fill="grey", width = 0.8)+
    geom_abline(slope = 0, intercept = 0)+
    geom_abline(slope = 0, intercept = r, linetype="dotted")+
    ggtitle("Decrease in fecundity or survivorship")+
    xlab("Vital rate parameter")+
    ylab("Intrinic rate of increase")+
    scale_x_discrete(limits=c("fecundity", as.character(turtleData$class)))+
    scale_y_continuous(limits=lim)+
    theme_classic()+
    theme(axis.text.x = element_text(angle = 45, hjust=1, size=10),
          axis.title = element_text(hjust=0.5),
          title = element_text(size=9.5, face='bold', hjust=0.1))

p2 <- ggplot(sens, aes(x = S+1, y = grow.inc))+
    geom_bar(stat="identity", position = "identity",
             fill="grey", width = 0.8)+
    geom_abline(slope = 0, intercept = 0)+
    geom_abline(slope = 0, intercept = r, linetype="dotted")+
    ggtitle("Increase in fecundity or survivorship")+
    xlab("Vital rate parameter")+
    ylab("Intrinic rate of increase")+
    scale_x_discrete(limits=c("fecundity", as.character(turtleData$class)))+
    scale_y_continuous(limits=lim)+
    theme_classic()+
    theme(axis.text.x = element_text(angle = 45, hjust=1, size=10),
          axis.title = element_text(hjust=0.5),
          title = element_text(size=9.5, face='bold', hjust=0.1))

grid.arrange(p1, p2, nrow=1)
```

The dotted line in the above plot indicates the baseline rate of increase.

## References